@{
    ViewData["Title"] = "Item Wise Sales";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/item-wise-sales.css?v=@Configuration["Assets:Version"]" />
<!-- Select2 for searchable dropdown (same as invoice items) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-0">ðŸ“Š Item Wise Sales</h2>
        <button type="button" id="btnPrintItemSales" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-printer me-1"></i> Print
        </button>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="itemSalesFilterForm" class="row g-3">
                <div class="col-md-2 col-sm-6">
                    <div class="invoice-filter-field">
                        <label class="form-label fw-bold invoice-filter-label">Category</label>
                        <select id="categoryFilter" class="form-select form-select-sm invoice-filter-input">
                            <option value="All">All</option>
                            <option value="Restaurant">Restaurant</option>
                            <option value="Rooms">Rooms</option>
                            <option value="Tours">Tours</option>
                            <option value="Laundry">Laundry</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-4 col-sm-6">
                    <div class="invoice-filter-field">
                        <label class="form-label fw-bold invoice-filter-label">Item</label>
                        <div class="d-flex align-items-center gap-2">
                            <select id="itemId" class="form-select form-select-sm flex-grow-1 orderSelect">
                                <option value="0">-- All Items --</option>
                            </select>
                            <button type="button" id="btnOpenItemSearch" class="btn btn-outline-secondary btn-sm flex-shrink-0" title="Search Items">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-sm-12">
                    <div class="invoice-filter-field">
                        <label class="form-label fw-bold invoice-filter-label">Date</label>
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <input type="date" name="fromDate" id="fromDate" class="form-control form-control-sm" style="max-width: 130px;" />
                            <input type="date" name="toDate" id="toDate" class="form-control form-control-sm" style="max-width: 130px;" />
                            <div class="d-flex gap-1 flex-wrap">
                                <button type="button" id="btnToday" class="btn btn-outline-secondary btn-sm flex-shrink-0">Today</button>
                                <button type="button" id="btnYesterday" class="btn btn-outline-secondary btn-sm flex-shrink-0">Yesterday</button>
                                <button type="button" id="btnMonth" class="btn btn-outline-secondary btn-sm flex-shrink-0">Month</button>
                                <button type="button" id="btnYear" class="btn btn-outline-secondary btn-sm flex-shrink-0">Year</button>
                            </div>
                            <button type="button" id="btnRefreshItemSales" class="btn btn-primary btn-sm ms-auto flex-shrink-0">
                                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="itemSalesLoadingIndicator" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading item wise sales...</p>
    </div>

    <!-- Desktop Table -->
    <div id="itemSalesTableDesktop">
        <div class="table-responsive shadow-sm">
            <table class="table table-striped table-hover table-bordered align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Item Description</th>
                        <th style="width: 15%;" class="text-end">
                            Qty
                            <span class="d-block small fw-normal">
                                Î£ <span id="itemSalesTotalQty">0.00</span>
                            </span>
                        </th>
                        <th style="width: 20%;" class="text-end">
                            Total
                            <span class="d-block small fw-normal">
                                Î£ <span id="itemSalesTotalAmount">LKR 0.00</span>
                            </span>
                        </th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody id="itemSalesTableBody">
                    <!-- Content loaded via AJAX -->
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-end mt-2">
            <div id="itemSalesPagination"></div>
        </div>
    </div>
</div>

<!-- Item Search Modal (similar to invoice Add Item modal) -->
<div class="modal fade" id="reportItemModal" tabindex="-1" aria-labelledby="reportItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width:95% !important;">
        <div class="modal-content" style="height:90vh; display: flex; flex-direction: column;">
            <div class="modal-header bg-primary text-white" style="flex: 0 0 auto;">
                <h5 class="modal-title fw-bold" id="reportItemModalLabel">
                    <i class="bi bi-box-seam me-2"></i>Select Item
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="reportItemContainer" style="display: flex; flex-direction: column; flex: 1 1 auto; overflow: hidden;"></div>
        </div>
    </div>
</div>

<!-- Item Invoices Modal -->
<div class="modal fade" id="itemInvoicesModal" tabindex="-1" aria-labelledby="itemInvoicesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="itemInvoicesModalLabel">
                    <i class="bi bi-receipt-cutoff me-2"></i>Item Invoices
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="itemInvoicesContent">
                    <!-- Filled dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="~/js/item-wise-sales.js?v=@Configuration["Assets:Version"]"></script>

