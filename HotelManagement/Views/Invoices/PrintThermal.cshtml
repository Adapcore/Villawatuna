@model HotelManagement.Models.Entities.Invoice
@using HotelManagement.Enums
@using Umbraco.Cms.Core.Web
@using Umbraco.Cms.Core.Models.PublishedContent
@inject IUmbracoContextAccessor UmbracoContextAccessor

@{
    Layout = null; // Remove layout for POS printing
    ViewBag.Title = "Print Invoice";
    // choose "width-80" or "width-58" — you can change here or via CSS
    var paperClass = "width-80";

    var invoiceType = "";
    switch (Model.Type)
    {
        case InvoiceType.Stay: invoiceType = "Stay"; break;
        case InvoiceType.Dining: invoiceType = "Dining"; break;
        case InvoiceType.TakeAway: invoiceType = "Take Away"; break;
        case InvoiceType.Laundry: invoiceType = "Laundry"; break;
        case InvoiceType.Tour: invoiceType = "Tour"; break;
        case InvoiceType.Other: invoiceType = "Other"; break;
    }

    // Get site information from Umbraco
    string siteName = "Hotel Management";
    string logoUrl = "";
    string address = "";
    string phone = "";
    string email = "";
    string website = "";
    bool showLogoOnly = false;

    var umbracoContext = UmbracoContextAccessor.GetRequiredUmbracoContext();
    var root = umbracoContext.Content?.GetAtRoot().FirstOrDefault();
    if (root != null)
    {
        var siteNode = root.DescendantsOrSelfOfType("site").FirstOrDefault();
        if (siteNode != null)
        {
            siteName = siteNode.Value<string>("siteName") ?? siteName;
            address = siteNode.Value<string>("address") ?? address;
            phone = siteNode.Value<string>("phone") ?? phone;
            email = siteNode.Value<string>("email") ?? email;
            website = siteNode.Value<string>("website") ?? siteNode.Value<string>("webSite") ?? "";
            showLogoOnly = siteNode.Value<bool>("showLogoOnly");
            var logoMedia = siteNode.Value<IPublishedContent>("logo");
            if (logoMedia != null)
            {
                logoUrl = logoMedia.Url() ?? "";
            }
        }
    }
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Invoice Print</title>
    <style>
        :root {
            --paper-width: 80mm; /* 58mm if needed */
            --font-size: 12px;
            --line: 1.35;
        }

        /* POS Printer Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font: normal var(--font-size)/var(--line) ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            background: #f1f1f1;
            /* font-family: 'Courier New', monospace;  */
            /* font-size: 12px;  */
            /* line-height: 1.2;
                                                                                                                            background: white;
                                                                                                                            color: black; */
        }

        /* paper widths: 58mm and 80mm */
        .width-58 {
            width: 58mm;
            max-width: 58mm;
        }

        .width-80 {
            width: 80mm;
            max-width: 80mm;
        }

        .receipt-container {
            margin: 0 auto;
            padding: 2mm;
        }

        .receipt-content {
            background: white;
            color: black;
        }

        /* Invoice header */
        .invoice-header {
            text-align: center;
            margin-bottom: 4mm;
            border-bottom: 1px dashed #000;
            /* padding-bottom: 0mm; */
        }

        .invoice-title {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 1mm;
        }

        .invoice-address {
            /* font-size: 10px; */
            margin-bottom: 2mm;
        }

        .invoice-meta {
            /* font-size: 10px; */
            margin-bottom: 2mm;
            border-bottom: 1px dashed #000;
            margin-bottom: 4mm;
        }

        /* Items table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2mm 0;
            /* font-size: 10px; */
        }

            .items-table th {
                text-align: left;
                border-bottom: 1px dashed #000;
                padding: 1mm 0;
                /* font-weight: bold; */
            }

            .items-table td {
                padding: 1mm 0;
                border-bottom: 1px dashed #ccc;
                margin-bottom: 4mm;
            }

        .item-name {
            width: 40%;
        }

        .stay-item-name {
            width: 50%;
        }

        .item-qty {
            width: 10%;
            text-align: center;
        }

        .stay-item-qty {
            width: 5%;
            text-align: center;
        }

        .item-price {
            width: 25%;
            text-align: right;
        }

        .stay-item-price {
            width: 20%;
            text-align: right;
        }

        .item-total {
            width: 25%;
            text-align: right;
        }

        /* Totals */
        .totals {
            border-top: 1px dashed #000;
            margin-top: 3mm;
            padding-top: 4mm;
            /* font-size: 1.2em;
                                                                                                                    font-weight: 700; */
        }

        .total-line {
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 1mm;
            gap: 8px;
        }

        .gross-total {
            font-weight: 700;
            font-size: 1.2em;
            /* border-top: 1px dashed #000;
                                                                            padding-top: 1mm;
                                                                            margin-top: 2mm; */
        }

        .total-bottom-border {
            border-bottom: 1px dashed #000;
            padding-bottom: 1mm;
            margin-bottom: 2mm;
        }

        /* Print styles */
        @@media print {
            @@page {
                size: var(--paper-width) auto;
                margin: 0;
            }


            body {
                font: normal var(--font-size)/var(--line) ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                margin: 0;
                padding: 0;
            }

            .receipt-container {
                margin: 0;
            }

            .no-print {
                display: none !important;
            }
        }

        /* @@page {
                                                                                                                            size: auto;
                                                                                                                            margin: 0;
                                                                                                                        } */
    </style>
</head>
<body>
    <div class="receipt-container @paperClass">
        <div class="receipt-content">
            <!-- Invoice Header -->
            <div class="invoice-header">
                @if (!string.IsNullOrEmpty(logoUrl))
                {
                    <div>
                        <img src="@logoUrl" alt="@siteName" style="max-height: 60px; max-width: 100%;" />
                    </div>
                }
                @if (!showLogoOnly)
                {
                    <div class="invoice-title">@siteName</div>
                }
                <div class="invoice-address">
                    @if (!string.IsNullOrEmpty(address))
                    {
                        <div>@address</div>
                    }
                    @if (!string.IsNullOrEmpty(phone))
                    {
                        <div>T : @phone</div>
                    }
                    @if (!string.IsNullOrEmpty(email))
                    {
                        <div>@email</div>
                    }
                    @if (!string.IsNullOrEmpty(website))
                    {
                        <div>@website</div>
                    }
                </div>
            </div>

            <div class="invoice-meta">
                <div>Invoice No: @Model.InvoiceNo</div>
                <div>Invoice Type: @invoiceType</div>
                <div>Date: @Model.Date.ToString("yyyy-MM-dd HH:mm")</div>
                @if (Model.Customer != null)
                {
                    string cusromerName = "";
                    if (!string.IsNullOrEmpty(Model.Customer.RoomNo))
                    {
                        cusromerName = $"#{Model.Customer.RoomNo} - ";
                    }

                    cusromerName = $"{cusromerName}{Model.Customer.FirstName} {Model.Customer.LastName}";

                    <div>Customer: @cusromerName</div>
                }
                @if (!string.IsNullOrWhiteSpace(Model.ReferenceNo))
                {
                    <div>Ref: @Model.ReferenceNo</div>
                }
            </div>

            <!-- Items Table -->
            <table class="items-table">
                @if (Model.Type == InvoiceType.Stay)
                {
                    <partial name="~/Views/Partials/invoices/StayDetails.cshtml" for="@Model" />
                }
                else
                {
                    <thead>
                        <tr>
                            <th style="text-align:left" class="item-name">Item</th>
                            <th style="text-align:center" class="item-qty">Qty</th>
                            <th style="text-align:center" class="item-price">Price</th>
                            <th style="text-align:center" class="item-total">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in Model.InvoiceDetails ?? Enumerable.Empty<HotelManagement.Models.Entities.InvoiceDetail>())
                        {
                            string itemName = d.Item.NoteRequired == true ? d.Note : d.Item?.Name;

                            <tr>
                                <td class="item-name">@itemName</td>
                                <td class="item-qty">@d.Quantity</td>
                                <td class="item-price">@d.UnitPrice.ToString("F2")</td>
                                <td class="item-total">@d.Amount.ToString("F2")</td>
                            </tr>
                        }
                    </tbody>
                }

            </table>

            <!-- Totals -->
            <div class="totals">

                @if (Model.Type == InvoiceType.Stay || Model.Type == InvoiceType.Tour)
                {
                    @if (Model.Currency != "LKR")
                    {
                        <div class="total-line">
                            <span>SubTotal (@Model.Currency) :</span>
                            <span>@Model.CurySubTotal.ToString("#,###.00")</span>
                        </div>
                        <div class="total-line total-bottom-border">
                            <span>Exchange Rate :</span>
                            <span>@Model.CurrencyRate?.ToString("F2")</span>
                        </div>
                    }
                }
                else if (Model.Type == InvoiceType.Dining)
                {
                    <div class="total-line">
                        <span>SubTotal:</span>
                        <span>@Model.SubTotal.ToString("#,###.00")</span>
                    </div>

                    <div class="total-line total-bottom-border">
                        <span>Service Charge:</span>
                        <span>@Model.ServiceCharge.ToString("#,###.00")</span>
                    </div>
                }

                <div class="total-line gross-total">
                    <span>GROSS TOTAL (LKR):</span>
                    <span>@Model.GrossAmount.ToString("#,###.00")</span>
                </div>

                @if (Model.Status != InvoiceStatus.InProgress && Model.Status != InvoiceStatus.Complete)
                {
                    @if (Model.Status == InvoiceStatus.PartiallyPaid)
                    {
                        if (@Model.Currency != "LKR" && @Model.CurryTotalPaid != null)
                        {
                            <div class="total-line">
                                <span>TOTAL PAID @Model.Currency:</span>
                                <span>@Model.CurryTotalPaid?.ToString("F2")</span>
                            </div>
                        }

                        <div class="total-line">
                            <span>TOTAL PAID (@Model.LastPaid.ToString("F2")):</span>
                            <span>@Model.TotalPaid.ToString("F2")</span>
                        </div>

                        <div class="total-line">
                            @{
                                string curryBalanceText = "";
                                if (@Model.Currency != "LKR" && @Model.CurryBalance != null)
                                {
                                     curryBalanceText = $"({Model.Currency} {Model.CurryBalance})";
                                }
                            }
                            <span>BALANCE DUE @curryBalanceText:</span>
                            <span>@Model.Balance.ToString("F2")</span>
                        </div>
                    }
                    else if (Model.Status == InvoiceStatus.Paid)
                    {
                        var totalPaid = Model.TotalPaid + Model.Change;

                        if (@Model.Currency != "LKR" && @Model.CurryTotalPaid != null && Model.CurryChange != null)
                        {
                            var curryTotalPaid = Model.CurryTotalPaid + Model.CurryChange;

                            <div class="total-line">
                                <span>TOTAL PAID @Model.Currency:</span>
                                <span>@curryTotalPaid?.ToString("F2")</span>
                            </div>
                        }

                        <div class="total-line">
                            <span>TOTAL PAID:</span>
                            <span>@totalPaid.ToString("F2")</span>
                        </div>

                        if (@Model.Currency != "LKR" && @Model.CurryChange != null)
                        {
                        <div class="total-line">
                                <span>Change @Model.Currency:</span>
                            <span>@Model.CurryChange?.ToString("F2")</span>
                        </div>
                        }
                        <div class="total-line">
                            <span>Change:</span>
                            <span>@Model.Change.ToString("F2")</span>
                        </div>
                    }
                }

                <div style="height:8px;"></div>

                <!-- footer -->
                <div style="text-align:center; padding-top:4mm">
                    Thank you for your visit!
                    <div style="height:4px;"></div>
                    <div>Powered by Adapcore</div>
                </div>

                <div style="height:6px;"></div>
            </div>
        </div>
    </div>

    <!-- Auto print and close -->
    <script>
        window.onload = function () {
            // Auto print when page loads
            window.print();

            // Close window after printing (with delay to ensure print dialog is handled)
            setTimeout(function () {
                window.close();
            }, 1000);
        };
    </script>
</body>
</html>
