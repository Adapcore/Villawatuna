@model HotelManagement.Models.CreateOrderViewModel
@using Microsoft.AspNetCore.Mvc.Rendering

<div class="container mt-4 mb-4">
    <h2>Create Order</h2>

    <form asp-action="Create" method="post">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <!-- Order fields -->
        <div class="mb-3">
            <label asp-for="Date" class="form-label"></label>
            <input asp-for="Date" type="date" class="form-control" />
        </div>

        <div class="mb-3">
            <label asp-for="CustomerId" class="form-label">Customer</label>
            <select asp-for="CustomerId" class="form-select" asp-items="ViewBag.Customers">
                <option value="">-- Select Customer --</option>
            </select>
        </div>

        <div class="mb-3">
            <label asp-for="TableNo" class="form-label"></label>
            <input asp-for="TableNo" class="form-control" />
        </div>

        <div class="form-check mb-3">
            <input asp-for="IsFreeOfCharge" class="form-check-input" />
            <label asp-for="IsFreeOfCharge" class="form-check-label"></label>
        </div>

        <div class="form-check mb-3">
            <input asp-for="Dining" class="form-check-input" />
            <label asp-for="Dining" class="form-check-label"></label>
        </div>

        <div class="mb-3">
            <label asp-for="Notes" class="form-label"></label>
            <textarea asp-for="Notes" class="form-control"></textarea>
        </div>

        <!-- Order Items -->
        <h4>Order Items</h4>
        <table class="table table-bordered" id="orderItemsTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Comments</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Amount</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added dynamically -->
            </tbody>
        </table>
        <button type="button" class="btn btn-secondary" id="addItemBtn">+ Add Item</button>

        <div class="mt-3">
            <label>Sub Total</label>
            <input asp-for="SubTotal" class="form-control" readonly />
        </div>

        <button type="submit" class="btn btn-primary mt-3">Save</button>
        <a class="btn btn-secondary mt-3" asp-action="Index">Cancel</a>
    </form>
</div>



<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>



<head>
    <script>
    $(document).ready(function() {
    let itemIndex = 0;

    function recalcTotals() {
        let subtotal = 0;
        $("#orderItemsTable tbody tr").each(function () {
            let qty = parseFloat($(this).find("input[name*='Qty']").val()) || 0;
            let price = parseFloat($(this).find("input[name*='UnitPrice']").val()) || 0;
            let amount = qty * price;
            $(this).find("input[name*='Amount']").val(amount.toFixed(2));
            subtotal += amount;
        });
        $("input[name='SubTotal']").val(subtotal.toFixed(2));
    }

    function reindexRows() {
        $("#orderItemsTable tbody tr").each(function (i) {
            $(this).find("input").each(function () {
                const name = $(this).attr("name");
                const newName = name.replace(/\d+/, i);
                $(this).attr("name", newName);
            });
        });
        itemIndex = $("#orderItemsTable tbody tr").length;
        recalcTotals();
    }

    $("#addItemBtn").click(function () {
        let row = `
            <tr>
                <td><input name="OrderItems[${itemIndex}].ItemId" class="form-control" /></td>
                <td><input name="OrderItems[${itemIndex}].Comments" class="form-control" /></td>
                <td><input name="OrderItems[${itemIndex}].Qty" class="form-control" type="number" value="1" /></td>
                <td><input name="OrderItems[${itemIndex}].UnitPrice" class="form-control" type="number" step="0.01" /></td>
                <td><input name="OrderItems[${itemIndex}].Amount" class="form-control" readonly /></td>
                <td><button type="button" class="btn btn-danger btn-sm removeItemBtn">X</button></td>
            </tr>
        `;
        $("#orderItemsTable tbody").append(row);
        itemIndex++;
    });

    $(document).on("input", "input[name*='Qty'], input[name*='UnitPrice']", recalcTotals);
    $(document).on("click", ".removeItemBtn", function () {
        $(this).closest("tr").remove();
        reindexRows();
    });
});
</script>
</head>

